#
# spec file for SUSE CAP buildpack dependency
#
# Copyright (c) 2018 SUSE LINUX GmbH, Nuernberg, Germany.
#
# All modifications and additions to the file contributed by third parties
# remain the property of their copyright owners, unless otherwise agreed
# upon. The license for this file, and modifications and additions to the
# file, is the same license as for the pristine package itself (unless the
# license for the pristine package is not an Open Source License, in which
# case the license is the MIT License). An "Open Source License" is a
# license that conforms to the Open Source Definition (Version 1.9)
# published by the Open Source Initiative.



Name:           php-<%= version %>
Version:        <%= version %>
Release:        1
Summary:        This is a dependency used in SUSE CAP buildpacks
License:        PHP-3.01
Group:          Cloud/Platform/scf
Url:            http://php.net/
Source0:        <%= source %>
Source1:        sources.yml
BuildRequires:  aspell-devel
BuildRequires:  libexpat-devel
BuildRequires:  gdbm-devel
BuildRequires:  gmp-devel
BuildRequires:  openldap2-devel
BuildRequires:  libldb-devel
BuildRequires:  libmcrypt-devel
BuildRequires:  libpng12-devel
BuildRequires:  libpng12-compat-devel
BuildRequires:  libpspell15
BuildRequires:  readline-devel
BuildRequires:  sqlite3-devel
BuildRequires:  libopenssl-devel
BuildRequires:  libuv-devel
BuildRequires:  libxml2-devel
BuildRequires:  libzip-devel
BuildRequires:  automake
BuildRequires:  freetype2-devel
BuildRequires:  libxslt-devel
BuildRequires:  libGeoIP-devel
BuildRequires:  ImageMagick-devel
BuildRequires:  cyrus-sasl-devel
BuildRequires:  imap-devel
BuildRequires:  krb5-devel
BuildRequires:  net-snmp-devel
BuildRequires:  libgpgme-devel

BuildRoot:      %{_tmppath}/%{name}-%{version}-build

<%= rpm_macros %>

%define prefix_path /php

%description

%prep
%setup -q -n %{name}

%build

./configure --prefix=%{destdir}%{prefix_path} \
      --disable-static \
      --enable-shared \
      --enable-ftp=shared \
      --enable-sockets=shared \
      --enable-soap=shared \
      --enable-fileinfo=shared \
      --enable-bcmath \
      --enable-calendar \
      --enable-intl \
      --with-kerberos \
      --enable-zip=shared \
      --with-bz2=shared \
      --with-curl=shared \
      --enable-dba=shared \
      --with-cdb \
      --with-gdbm \
      --with-mcrypt=shared \
      --with-mhash=shared \
      --with-mysql=shared \
      --with-mysqli=shared \
      --enable-pdo=shared \
      --with-pdo-sqlite=shared,/usr \
      --with-pdo-mysql=shared,mysqlnd \
      --with-mssql=shared \
      --with-pdo-dblib=shared \
      --with-gd=shared \
      --with-jpeg-dir=/usr \
      --with-freetype-dir=/usr \
      --enable-gd-native-ttf \
      --with-pdo-pgsql=shared \
      --with-pgsql=shared \
      --with-pspell=shared \
      --with-gettext=shared \
      --with-gmp=shared \
      --with-imap=shared \
      --with-imap-ssl=shared \
      --with-ldap=shared \
      --with-ldap-sasl \
      --with-zlib=shared \
      --with-xsl=shared \
      --with-snmp=shared \
      --enable-mbstring=shared \
      --enable-mbregex \
      --enable-exif=shared \
      --with-openssl=shared \
      --enable-fpm \
      --enable-pcntl=shared \
      --with-readline=shared \
      --enable-sysvsem=shared \
      --enable-sysvshm=shared \
      --enable-sysvmsg=shared \
      --enable-shmop=shared \
      --with-libdir=lib64

make -j4

%install
make install


TARBALL=%{otherdir}/%{name}-linux-x64.tgz

pushd %{destdir}%{prefix_path}
cp %{SOURCE1} ../
rm "etc/php-fpm.conf.default"
rm -rf "include"
rm -rf "php"
rm -rf "lib/php/build"
rm "bin/php-cgi"
find "lib/php/extensions" -name "*.a" -type f -delete
cd ..
tar czf ${TARBALL} --hard-dereference * --owner=0 --group=0
popd

CHECKSUM=`sha256sum ${TARBALL}`
NEW_TARBALL=%{otherdir}/%{name}-linux-x64-%{stack}-${CHECKSUM:0:8}.tgz
mv ${TARBALL} ${NEW_TARBALL}

echo `sha256sum ${NEW_TARBALL}` > %{otherdir}/$(basename ${NEW_TARBALL}).sha256

%files
%defattr(-,root,root)

%changelog

